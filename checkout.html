<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - GameStore</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    emailjs.init("PHWoyPU-qSM2lBH7x");
  </script>
</head>
<body>
  <main class="checkout-container">
    <h1>Resumen de tu pedido</h1>

    <section class="datos-usuario">
      <h2>Datos del cliente</h2>
      <p><strong>Nombre:</strong> <span id="nombre"></span></p>
      <p><strong>Apellido:</strong> <span id="apellido"></span></p>
      <p><strong>Teléfono:</strong> <span id="telefono"></span></p>
      <p><strong>Correo:</strong> <span id="correo"></span></p>
    </section>

    <section class="lista-carrito">
      <h2>Juegos seleccionados</h2>
      <ul id="carrito"></ul>
    </section>

    <section class="metodos-pago">
      <h2>Métodos de pago</h2>
      <ul>
        <li><strong>Pago Móvil:</strong> 22123456 4121234567 (Banesco)</li>
        <li><strong>Depósito en efectivo:</strong></li>
        <li>Bancamiga: #123456789</li>
        <li>Mercantil: #987654321</li>
      </ul>
    </section>

    <section class="cotizacion-final">
      <h2>Cotización</h2>
      <p><strong>Número de cotización:</strong> <span id="cotizacion"></span></p>
      <p><strong>Total a pagar:</strong> <span id="total"></span></p>
      <button id="confirmar-pedido">Confirmar pedido</button>
      <button onclick="window.location.href='carrito.html'" style="margin-left: 10px; background-color: gray; color: white;">Cancelar</button>
    </section>
  </main>

  <!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
  import { auth } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const carrito = JSON.parse(localStorage.getItem("carrito")) || [];
  const ul = document.getElementById("carrito");
  const cotizacionSpan = document.getElementById("cotizacion");

  let juegos_array = [];
  let total = 0;

  // Mostrar juegos con precios y calcular total
  carrito.forEach(item => {
    const precio = item.tipo === "Comprar" ? 25 : 10;
    juegos_array.push({ titulo: item.titulo, tipo: item.tipo, precio });

    const li = document.createElement("li");
    li.textContent = `${item.titulo} (${item.tipo}) - $${precio}`;
    ul.appendChild(li);

    total += precio;
  });

  // Mostrar total en la página
  const totalHTML = document.createElement("p");
  totalHTML.innerHTML = `<strong>Total:</strong> $${total}`;
  totalHTML.style.marginTop = "10px";
  totalHTML.style.fontSize = "1.2em";
  totalHTML.style.fontWeight = "bold";
  ul.parentNode.appendChild(totalHTML);

  // Datos del usuario
  let nombre = "", apellido = "", telefono = "", correo = "";

  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    const partes = user.displayName ? user.displayName.split(" ") : [];
    nombre = partes[0] || "";
    apellido = partes.slice(1).join(" ") || "";
    telefono = localStorage.getItem("telefono") || "No registrado";
    correo = user.email;

    document.getElementById("nombre").textContent = nombre;
    document.getElementById("apellido").textContent = apellido;
    document.getElementById("telefono").textContent = telefono;
    document.getElementById("correo").textContent = correo;
  });

  // Cotización
  function generarCotizacion() {
    let ultima = localStorage.getItem("ultimaCotizacion") || "000000";
    let nueva = (parseInt(ultima) + 1).toString().padStart(6, "0");
    localStorage.setItem("ultimaCotizacion", nueva);
    return nueva;
  }

  const numeroCotizacion = generarCotizacion();
  cotizacionSpan.textContent = numeroCotizacion;

  // Confirmar pedido
  document.getElementById("confirmar-pedido").addEventListener("click", () => {
    const templateParams = {
      to_email: correo,
      from_name: `${nombre} ${apellido}`,
      cotizacion: numeroCotizacion,
      juegos_array,
      telefono,
      correo,
      total: `$${total}`,
      admin_email: "servitodo200@gmail.com"
    };

    emailjs.send("service_v1r0jyq", "template_kocrnu9", templateParams)
      .then(() => {
        Swal.fire({
          icon: 'success',
          title: 'Pedido confirmado',
          html: `Tu cotización <strong>#${numeroCotizacion}</strong> fue enviada por correo.`,
          confirmButtonText: 'Volver al inicio'
        }).then(() => {
          localStorage.removeItem("carrito");
          window.location.href = "index.html";
        });
      }, (error) => {
        console.error("Error al enviar correo:", error);
        Swal.fire({
          icon: 'error',
          title: 'Error al enviar correo',
          text: 'Ocurrió un error al enviar el correo. Inténtalo de nuevo.'
        });
      });
  });
</script>

</body>
</html>